import{j as e}from"./jsx-runtime-BTp501oS.js";import{a,q as re,t as Z,O as Oe,v as fe}from"./chunk-EPOLDU6W-DaRFMLBV.js";function $e(){return"https://api.from-trees.com"}function E(t,n){const i=$e().replace(/\/$/,""),m=t.startsWith("/")?t:`/${t}`,h=new URL(`${i}${m}`);if(n)for(const[k,j]of Object.entries(n))j!=null&&h.searchParams.set(k,String(j));return h.toString()}async function D(t,n={}){const i=performance.now();let m,h="",k=null;const j=new Headers(n.headers||{});try{m=await fetch(t,{...n,credentials:"include",headers:j})}catch(S){throw new Error(S instanceof Error?S.message:"Network request failed")}try{h=await m.text(),h&&(k=JSON.parse(h))}catch{const R=Math.round(performance.now()-i);return{ok:m.ok,status:m.status,data:null,text:h,headers:m.headers,durationMs:R}}const y=Math.round(performance.now()-i);return{ok:m.ok,status:m.status,data:k,text:h,headers:m.headers,durationMs:y}}function Me(){const[t,n]=a.useState(null);return a.useEffect(()=>{},[]),null}function Ae(t){return!!t&&typeof t=="object"&&!Array.isArray(t)}function je(t){if(t===null)return"null";if(typeof t=="string")return`"${t}"`;if(typeof t=="number"||typeof t=="boolean")return String(t);if(Array.isArray(t))return t.length===0?"[]":e.jsxs("details",{open:!0,children:[e.jsxs("summary",{children:["[",t.length,"]"]}),e.jsx("div",{className:"xf18ygs x78zum5 xdt5ytf x1jnr06f",children:t.map((n,i)=>e.jsxs("div",{className:"x78zum5 x17d4w8g x1pha0wt",children:[e.jsx("span",{className:"x1e3jit x1s688f",children:i}),e.jsx("span",{className:"xo8r7s1",children:":"}),e.jsx("span",{className:"xvqfk9l",children:je(n)})]},i))})]});if(Ae(t)){const n=Object.entries(t);return n.length===0?"{}":e.jsxs("details",{open:!0,children:[e.jsxs("summary",{children:["{...}"," ",n.length," keys"]}),e.jsx("div",{className:"xf18ygs x78zum5 xdt5ytf x1jnr06f",children:n.map(([i,m])=>e.jsxs("div",{className:"x78zum5 x17d4w8g x1pha0wt",children:[e.jsx("span",{className:"x1e3jit x1s688f",children:i}),e.jsx("span",{className:"xo8r7s1",children:":"}),e.jsx("span",{className:"xvqfk9l",children:je(m)})]},i))})]})}return String(t)}function de({data:t}){return e.jsx("div",{className:"xze3p7c xfifm61 xvqfk9l",children:je(t)})}function Le({payloadText:t,onChange:n}){return e.jsx("div",{className:"x78zum5 xdt5ytf x167g77z",children:e.jsxs("label",{className:"x78zum5 xdt5ytf x17d4w8g",children:["Advanced: Edit Payload",e.jsx("textarea",{rows:8,value:t,onChange:i=>n(i.target.value)})]})})}function Ue({scenario:t}){return e.jsxs("div",{className:"xc7ga6q xur7f20 xht5q6y",children:[e.jsx("h3",{children:t.name}),e.jsx("p",{children:t.description})]})}function Je({scenarios:t,selectedId:n,onSelect:i}){return e.jsx("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:e.jsxs("label",{children:["Scenario",e.jsx("select",{value:n,onChange:m=>i(m.target.value),children:t.map(m=>e.jsx("option",{value:m.id,children:m.name},m.id))})]})})}function ye(t){return{record:{uri:`manual://proposal/${t}`,kind:"proposal",customer:{display:"Jane Smith"},commitments:{quotedDeliveryDate:"2026-03-15",quotedInstallDate:"2026-03-20"},currency:"USD"},line_items:[{uri:`manual://proposal/${t}/line/table`,title:"Ash Dining Table",category_key:"furniture",deliverable_key:"dining_table",quantity:1,position:1,config:{woodSpecies:"ash",finish:"smoke",dimensions:{length:84,width:40,height:30},requiresDesign:!0,requiresApproval:!0}},{uri:`manual://proposal/${t}/line/delivery`,title:"White-glove delivery",category_key:"delivery",deliverable_key:"delivery_service",quantity:1,position:2,config:{deliveryRequired:!0}},{uri:`manual://proposal/${t}/line/install`,title:"On-site installation",category_key:"install",deliverable_key:"install_service",quantity:1,position:3,config:{installRequired:!0}}]}}function ve(t){return{record:{uri:`manual://proposal/${t}`,kind:"proposal",customer:{display:"Anderson Residence"},commitments:{quotedInstallDate:"2026-04-10"},currency:"USD"},line_items:[{uri:`manual://proposal/${t}/line/kitchen`,title:"Kitchen base cabinets",category_key:"cabinetry",deliverable_key:"cabinet_run",group_key:"kitchen",quantity:1,position:1,config:{room:"Kitchen",style:"Shaker",material:"Painted maple",requiresSamples:!0,installRequired:!0}},{uri:`manual://proposal/${t}/line/pantry`,title:"Pantry storage cabinets",category_key:"cabinetry",deliverable_key:"cabinet_run",group_key:"kitchen",quantity:1,position:2,config:{room:"Pantry",style:"Shaker",material:"Painted maple",requiresSamples:!0,installRequired:!0}}]}}function ge(t){return{record:{uri:`manual://proposal/${t}`,kind:"proposal",customer:{display:"Lopez Condo"},currency:"USD"},line_items:[{uri:`manual://proposal/${t}/line/design`,title:"Custom kitchen design package",category_key:"design",deliverable_key:"design_services",quantity:1,position:1,config:{revisionLimit:3,deliverables:["3D renderings","AR walkthrough"],requiresApproval:!0}}]}}function Te(t,n){return{record:{uri:`manual://proposal/${t}`,kind:"proposal",customer:{display:"Replay Test"},currency:"USD"},line_items:[{uri:`manual://proposal/${t}/line/table`,title:"Walnut Coffee Table",category_key:"furniture",deliverable_key:"coffee_table",quantity:1,position:1,config:{woodSpecies:"walnut",requiresDesign:n}}]}}const se=[{id:"manual-proposal",name:"Manual proposal (furniture + delivery + install)",description:"Dining table with delivery/install line items and design/approval flags.",defaultRequest:{source:"manual",type:"commercial_record_upserted",baseExternalId:"proposal-demo",payload:ye("proposal-demo")},supports:{idStrategies:["increment","random","fixed","timestamped"]},buildRequest:({externalId:t})=>({source:"manual",type:"commercial_record_upserted",payload:ye(t)})},{id:"cabinetry-grouped",name:"Cabinetry (shared samples + install)",description:"Grouped cabinet runs that require samples and install for shared planning.",defaultRequest:{source:"manual",type:"commercial_record_upserted",baseExternalId:"cabinet-demo",payload:ve("cabinet-demo")},supports:{idStrategies:["increment","random","fixed","timestamped"]},buildRequest:({externalId:t})=>({source:"manual",type:"commercial_record_upserted",payload:ve(t)})},{id:"design-only",name:"Design-only engagement",description:"Design services only, with approval flag and no delivery/install.",defaultRequest:{source:"manual",type:"commercial_record_upserted",baseExternalId:"design-demo",payload:ge("design-demo")},supports:{idStrategies:["increment","random","fixed","timestamped"]},buildRequest:({externalId:t})=>({source:"manual",type:"commercial_record_upserted",payload:ge(t)})},{id:"idempotency-variant",name:"Idempotency + change detection",description:"Re-send with fixed externalId and flip requiresDesign to test idempotency.",defaultRequest:{source:"manual",type:"commercial_record_upserted",baseExternalId:"idempotency-demo",payload:Te("idempotency-demo",!1)},supports:{idStrategies:["fixed","timestamped","random"]}}];function Fe(t,n){return Te(t,n==="on")}const We={selectedScenarioId:se[0]?.id??"",counters:{},payloadOverrides:{},variantByScenario:{},baseExternalId:se[0]?.defaultRequest.baseExternalId??"",idStrategy:"increment",repeatCount:3,delayMs:300};function Ke(){const[t,n]=a.useState(We),[i,m]=a.useState([]),[h,k]=a.useState(null),[j,y]=a.useState(!1),S=a.useRef(!1),R=re(),c=a.useMemo(()=>se.find(o=>o.id===t.selectedScenarioId)??se[0],[t.selectedScenarioId]),p=a.useMemo(()=>{const o=t.payloadOverrides[c.id];return o!==void 0?o:JSON.stringify(c.defaultRequest.payload,null,2)},[c,t.payloadOverrides]),g=a.useMemo(()=>{try{return JSON.parse(p),null}catch{return"Payload JSON must be valid."}},[p]);function l(o){n(z=>({...z,...o}))}function u(o){const z=se.find(M=>M.id===o);z&&l({selectedScenarioId:o,baseExternalId:z.defaultRequest.baseExternalId,idStrategy:z.supports.idStrategies.includes(t.idStrategy)?t.idStrategy:z.supports.idStrategies[0]??"fixed"})}function C(){l({baseExternalId:c.defaultRequest.baseExternalId,payloadOverrides:{...t.payloadOverrides,[c.id]:JSON.stringify(c.defaultRequest.payload,null,2)}})}function _(){const o={...t.payloadOverrides};delete o[c.id],l({payloadOverrides:o,baseExternalId:c.defaultRequest.baseExternalId,idStrategy:c.supports.idStrategies[0]??"fixed"})}function x(o){l({payloadOverrides:{...t.payloadOverrides,[c.id]:o}})}function N(o){l({counters:{...t.counters,[c.id]:o}})}function q(o){l({variantByScenario:{...t.variantByScenario,[c.id]:o}})}function P(o){m(z=>[o,...z].slice(0,50))}function I(o){switch(t.idStrategy){case"increment":return`${t.baseExternalId}-${o+1}`;case"random":return`${t.baseExternalId}-${Math.random().toString(36).slice(2,8)}`;case"timestamped":return`${t.baseExternalId}-${Date.now()}`;case"fixed":default:return t.baseExternalId}}function W(o,z){if(c.id==="idempotency-variant"){const M=t.variantByScenario[c.id]??"off";return Fe(o,M)}if(c.buildRequest)return c.buildRequest({externalId:o,nowIso:z}).payload;try{return JSON.parse(p)}catch{return c.defaultRequest.payload}}async function J(o){if(g){k("Fix payload JSON before sending.");return}k(null),y(!0),S.current=!1;let z=t.counters[c.id]??0;for(let M=0;M<o&&!S.current;M+=1){const B=new Date().toISOString(),K=I(z),H=W(K,B),F=await D(E("/events/test"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source:c.defaultRequest.source,type:c.defaultRequest.type,externalId:K,payload:H})}),V=F.data&&typeof F.data=="object"&&(F.data.idempotencyKey||F.data.idempotency_key)||null;P({id:`${c.id}-${Date.now()}-${M}`,time:B,scenarioId:c.id,scenarioName:c.name,externalId:K,status:F.status,idempotencyKey:V,error:F.ok?null:F.text||"Request failed."}),t.idStrategy==="increment"&&(z+=1,N(z)),M<o-1&&t.delayMs>0&&await new Promise(Q=>setTimeout(Q,t.delayMs))}y(!1)}function v(){S.current=!0,y(!1)}function d(o){const z=`manual://proposal/${o}`;R(`/plan-preview/${encodeURIComponent(z)}`)}return e.jsxs("div",{className:"x78zum5 xdt5ytf xou54vl",children:[e.jsx("div",{className:"x78zum5 x1qughib",children:e.jsxs("div",{children:[e.jsx("h2",{children:"Demo"}),e.jsx("p",{children:"Trigger example events via POST /events/test."})]})}),e.jsxs("div",{className:"x78zum5 x1a02dak x1v2ro7d x6s0dn4",children:[e.jsx(Je,{scenarios:se,selectedId:c.id,onSelect:u}),e.jsxs("div",{className:"x78zum5 x1a02dak x167g77z x6s0dn4",children:[e.jsx("button",{type:"button",onClick:C,children:"Load scenario"}),e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l x1arfzav xur7f20 x1ypdohk",onClick:_,children:"Reset to defaults"})]})]}),e.jsx(Ue,{scenario:c}),e.jsxs("div",{className:"xrvj5dj x1v2ro7d",children:[e.jsxs("label",{children:["Source",e.jsx("input",{type:"text",value:c.defaultRequest.source,disabled:!0})]}),e.jsxs("label",{children:["Type",e.jsx("input",{type:"text",value:c.defaultRequest.type,disabled:!0})]}),e.jsxs("label",{children:["Base External ID",e.jsx("input",{type:"text",value:t.baseExternalId,onChange:o=>l({baseExternalId:o.target.value})})]}),e.jsxs("label",{children:["ID Strategy",e.jsx("select",{value:t.idStrategy,onChange:o=>l({idStrategy:o.target.value}),children:c.supports.idStrategies.map(o=>e.jsx("option",{value:o,children:o},o))})]}),e.jsxs("label",{children:["Repeat Count",e.jsx("input",{type:"number",min:1,value:t.repeatCount,onChange:o=>l({repeatCount:Number(o.target.value)})})]}),e.jsxs("label",{children:["Delay (ms)",e.jsx("input",{type:"number",min:0,value:t.delayMs,onChange:o=>l({delayMs:Number(o.target.value)})})]})]}),c.id==="idempotency-variant"&&e.jsxs("div",{className:"x78zum5 x1v2ro7d x6s0dn4 x1a02dak",children:[e.jsx("span",{children:"Variant"}),e.jsxs("label",{className:"x3nfvp2 x6s0dn4 x17d4w8g",children:[e.jsx("input",{type:"radio",name:"variant",checked:(t.variantByScenario[c.id]??"off")==="off",onChange:()=>q("off")}),"requiresDesign false"]}),e.jsxs("label",{className:"x3nfvp2 x6s0dn4 x17d4w8g",children:[e.jsx("input",{type:"radio",name:"variant",checked:(t.variantByScenario[c.id]??"off")==="on",onChange:()=>q("on")}),"requiresDesign true"]})]}),e.jsx(Le,{payloadText:p,onChange:x}),g&&e.jsx("div",{className:"x1tp81k5",children:g}),h&&e.jsx("div",{className:"x1tp81k5",children:h}),e.jsxs("div",{className:"x78zum5 x1a02dak x167g77z x6s0dn4",children:[e.jsx("button",{type:"button",onClick:()=>J(1),disabled:j,children:"Send Once"}),e.jsxs("button",{type:"button",onClick:()=>J(t.repeatCount),disabled:j,children:["Send ",t.repeatCount]}),e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l x1arfzav xur7f20 x1ypdohk",onClick:v,children:"Stop"})]}),e.jsxs("section",{className:"xur7f20 xc7ga6q xht5q6y",children:[e.jsxs("div",{className:"x78zum5 x1qughib x6s0dn4 x1e56ztr",children:[e.jsx("h3",{children:"Results Log"}),e.jsx("span",{children:"Last 50"})]}),i.length===0&&e.jsx("div",{className:"xo8r7s1",children:"No events sent yet."}),i.length>0&&e.jsx("div",{className:"xur7f20 xw2csxc",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"time"}),e.jsx("th",{children:"scenario"}),e.jsx("th",{children:"external_id"}),e.jsx("th",{children:"status"}),e.jsx("th",{children:"idempotencyKey"}),e.jsx("th",{children:"open"}),e.jsx("th",{children:"error"})]})}),e.jsx("tbody",{children:i.map(o=>e.jsxs("tr",{children:[e.jsx("td",{children:o.time}),e.jsx("td",{children:o.scenarioName}),e.jsx("td",{children:o.externalId}),e.jsx("td",{children:o.status??""}),e.jsx("td",{children:o.idempotencyKey??""}),e.jsx("td",{children:o.error?"":e.jsx("button",{type:"button",className:"x1heipig x1bvjpef x1717udv x1ypdohk",onClick:()=>d(o.externalId),children:"Open"})}),e.jsx("td",{children:o.error??""})]},o.id))})]})})]})]})}function Be({data:t}){const[n,i]=a.useState(!1),[m,h]=a.useState(null),[k,j]=a.useState(""),y=a.useMemo(()=>t?.contexts,[t]),S=a.useMemo(()=>t?.matchedTemplatesByContext??{},[t]),R=a.useMemo(()=>Array.isArray(y?.shared)?y?.shared??[]:[],[y]),c=a.useMemo(()=>Array.isArray(y?.deliverables)?y?.deliverables??[]:[],[y]),p=a.useMemo(()=>{const l=k.trim().toLowerCase();return l?c.filter(u=>{const C=`deliverable::${u.key}`,x=(S[C]??[]).map(q=>`${q.templateKey} ${q.title??""}`).join(" ");return[u.key,u.title,u.category_key,u.deliverable_key,u.group_key,x].filter(Boolean).join(" ").toLowerCase().includes(l)}):c},[c,k,S]),g=(l,u)=>S[`${l}::${u}`]??[];return!y||!y.project?null:e.jsxs("div",{className:"x78zum5 xdt5ytf xou54vl x9hd93c x1tamke2 xht5q6y",children:[e.jsxs("div",{className:"x78zum5 xuk3077 x1qughib x1v2ro7d",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Contexts"}),e.jsx("p",{children:"Derived contexts and rule matches for this record."})]}),e.jsxs("label",{className:"x3nfvp2 x17d4w8g x6s0dn4",children:[e.jsx("input",{type:"checkbox",checked:n,onChange:l=>i(l.target.checked)}),"Show rule IDs"]})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x167g77z",children:[e.jsx("h4",{children:"Project"}),e.jsxs("details",{className:"x9hd93c xc7ga6q xh2izcj",open:!0,children:[e.jsxs("summary",{className:"x78zum5 x1a02dak x167g77z x6s0dn4 x1ypdohk",children:[e.jsx("span",{className:"xmfpazt xur7f20 x1j6dyjg xtvhhri x1dgsrnt xczs1px x1jfab7n",children:"Project"}),e.jsx("span",{className:"xze3p7c xfifm61",children:le(y.project.key)}),y.project.customer_display&&e.jsx("span",{className:"x1s688f",children:y.project.customer_display})]}),e.jsxs("div",{className:"x1xmf6yo x78zum5 xdt5ytf x883omv",children:[e.jsxs("div",{className:"xrvj5dj x17d4w8g xfifm61 x1e3jit",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"record_uri:"})," ",y.project.record_uri]}),e.jsxs("div",{children:[e.jsx("strong",{children:"quoted_delivery_date:"})," ",y.project.quoted_delivery_date??"n/a"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"quoted_install_date:"})," ",y.project.quoted_install_date??"n/a"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"snapshot_hash:"})," ",y.project.snapshot_hash??"n/a"]})]}),e.jsx(me,{matches:g("project",y.project.key),showRuleIds:n})]})]})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x167g77z",children:[e.jsx("h4",{children:"Shared"}),R.length===0&&e.jsx("p",{className:"xo8r7s1",children:"No shared contexts."}),R.map(l=>e.jsxs("details",{className:"x9hd93c xc7ga6q xh2izcj",children:[e.jsxs("summary",{className:"x78zum5 x1a02dak x167g77z x6s0dn4 x1ypdohk",children:[e.jsx("span",{className:"xmfpazt xur7f20 x1j6dyjg xtvhhri x1dgsrnt x1lsnha7 x3ycguq",children:"Shared"}),e.jsx("span",{className:"xze3p7c xfifm61",children:le(l.key)}),e.jsxs("span",{className:"x1s688f",children:[l.line_items.length," line items"]})]}),e.jsxs("div",{className:"x1xmf6yo x78zum5 xdt5ytf x883omv",children:[e.jsxs("div",{className:"xrvj5dj x17d4w8g xfifm61 x1e3jit",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"group_key:"})," ",l.group_key]}),e.jsxs("div",{children:[e.jsx("strong",{children:"requiresSamples:"})," ",String(l.derived?.requiresSamples??!1)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"installRequired:"})," ",String(l.derived?.installRequired??!1)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"deliveryRequired:"})," ",String(l.derived?.deliveryRequired??!1)]})]}),e.jsx("div",{className:"x78zum5 xdt5ytf x1jnr06f",children:l.line_items.map(u=>e.jsxs("div",{children:[le(u.line_item_uri)," — ",u.title??"Untitled"," (",u.category_key,"/",u.deliverable_key,")"]},u.line_item_uri))}),e.jsx(me,{matches:g("shared",l.key),showRuleIds:n})]})]},l.key))]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x167g77z",children:[e.jsxs("div",{className:"x78zum5 x6s0dn4 x1qughib",children:[e.jsx("h4",{children:"Deliverables"}),e.jsxs("div",{className:"x78zum5 x6s0dn4 x167g77z x1a02dak",children:[e.jsx("input",{type:"text",placeholder:"Search deliverables...",value:k,onChange:l=>j(l.target.value)}),m&&e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l xk61eof xiq63ov x1ypdohk",onClick:()=>h(null),children:"Clear selection"})]})]}),p.length===0&&e.jsx("p",{className:"xo8r7s1",children:"No deliverable contexts match."}),p.map(l=>{const u=g("deliverable",l.key),C=m===l.key,_=!m||m===l.key;return e.jsxs("details",{className:{0:"x9hd93c xc7ga6q xh2izcj",1:"x9hd93c xc7ga6q x1hdarym x1tiokuu"}[!!C<<0],onClick:()=>h(C?null:l.key),children:[e.jsxs("summary",{className:"x78zum5 x1a02dak x167g77z x6s0dn4 x1ypdohk",children:[e.jsx("span",{className:"xmfpazt xur7f20 x1j6dyjg xtvhhri x1dgsrnt x1el1eiv x1tp81k5",children:"Deliverable"}),e.jsx("span",{className:"xze3p7c xfifm61",children:le(l.key)}),e.jsx("span",{className:"x1s688f",children:l.title??"Untitled"}),e.jsxs("span",{className:"xfifm61 xo8r7s1",children:[l.category_key,"/",l.deliverable_key]}),l.group_key&&e.jsxs("span",{className:"xfifm61 xo8r7s1",children:["group: ",l.group_key]})]}),e.jsxs("div",{className:"x1xmf6yo x78zum5 xdt5ytf x883omv",children:[e.jsxs("div",{className:"xrvj5dj x17d4w8g xfifm61 x1e3jit",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"quantity:"})," ",l.quantity??0]}),e.jsxs("div",{children:[e.jsx("strong",{children:"position:"})," ",l.position??"n/a"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"config_hash:"})," ",l.config_hash??"n/a"]}),l.configParseError&&e.jsxs("div",{className:"x1tp81k5",children:[e.jsx("strong",{children:"config error:"})," ",l.configParseError]})]}),l.config&&e.jsx("pre",{className:"x1tja46j xvqfk9l x7z7khe xiq63ov x1j6dyjg xw2csxc",children:JSON.stringify(l.config,null,2)}),_&&e.jsx(me,{matches:u,showRuleIds:n}),!_&&e.jsx("p",{className:"xo8r7s1",children:"Select to view matches."})]})]},l.key)})]})]})}function me({matches:t,showRuleIds:n}){return t.length?e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g xfifm61",children:[e.jsx("strong",{children:"Matched templates"}),e.jsx("ul",{children:t.map((i,m)=>e.jsxs("li",{children:[e.jsx("span",{className:"x1s688f",children:i.title??i.templateKey}),e.jsx("span",{className:"x1e3jit x16vho4v",children:i.templateKey}),e.jsxs("span",{className:"xo8r7s1 x16vho4v",children:["priority ",i.rulePriority]}),n&&e.jsxs("span",{className:"xo8r7s1 x16vho4v",children:["rule ",i.ruleId]})]},`${i.templateKey}-${i.ruleId}-${m}`))})]}):e.jsx("p",{className:"xo8r7s1",children:"No matching templates."})}function le(t,n=36){return t.length<=n?t:`${t.slice(0,18)}…${t.slice(-14)}`}function Ve(t){return D(E("/commercial-records",{limit:t.limit,offset:t.offset,query:t.query}),{method:"GET"})}function Ge({selectedUri:t,onSelect:n}){const[i,m]=a.useState([]),[h,k]=a.useState(!1),[j,y]=a.useState(""),[S,R]=a.useState(null);a.useEffect(()=>{const p=setTimeout(()=>{c(j)},300);return()=>clearTimeout(p)},[j]),a.useEffect(()=>{c("")},[]);async function c(p){k(!0),R(null);const g=await Ve({limit:50,offset:0,query:p||void 0});if(!g.ok){const l=g.data&&typeof g.data=="object"?g.data.error:void 0;R(l==="commercial_schema_not_installed"?"Commercial schema is not installed in this environment yet.":g.text||"Failed to load commercial records."),m([]),k(!1);return}m(g.data?.records??[]),k(!1)}return e.jsxs("aside",{className:"x9hd93c xc7ga6q xht5q6y x78zum5 xdt5ytf x1v2ro7d",children:[e.jsxs("div",{className:"x78zum5 x6s0dn4 x1qughib",children:[e.jsx("h3",{children:"Commercial Records"}),e.jsx("button",{type:"button",onClick:()=>c(j),children:"Refresh"})]}),e.jsxs("label",{className:"x78zum5 xdt5ytf x17d4w8g xfifm61",children:["Search",e.jsx("input",{type:"text",placeholder:"uri, customer, external_id",value:j,onChange:p=>y(p.target.value)})]}),h&&e.jsx("div",{className:"xo8r7s1",children:"Loading records..."}),S&&e.jsx("div",{className:"x1tp81k5",children:S}),!h&&!S&&i.length===0&&e.jsx("div",{className:"xo8r7s1",children:"No records found."}),e.jsx("div",{className:"x78zum5 xdt5ytf x167g77z",children:i.map(p=>{const g=p.uri===t;return e.jsxs("button",{type:"button",className:{0:"xdpxx8g xiq63ov x7z7khe xh2izcj x1ypdohk",1:"xdpxx8g xiq63ov x7z7khe x1ypdohk x1hdarym x1tiokuu"}[!!g<<0],onClick:()=>n(p.uri),children:[e.jsx("div",{className:"x1s688f xfifm61",children:He(p.uri)}),e.jsxs("div",{className:"x78zum5 xdt5ytf x1jnr06f x1j6dyjg x1e3jit",children:[e.jsxs("span",{children:[p.source,"/",p.kind]}),p.customer_display&&e.jsx("span",{children:p.customer_display}),e.jsx("span",{children:p.last_seen_at||"no last_seen_at"})]})]},p.uri)})})]})}function He(t){return t.length<=48?t:`${t.slice(0,24)}…${t.slice(-16)}`}async function Qe(){return D(E("/projects"))}async function Xe(t){return D(E(`/projects/${t}`))}async function Ye(t){return D(E(`/projects/${t}/tasks`))}async function Ze(t,n){return D(E(`/tasks/${t}`),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:n})})}async function ke(t){return D(E(`/tasks/${t}/notes`))}async function et(t,n){return D(E(`/tasks/${t}/notes`),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({body:n})})}async function tt(t){return D(E("/projects/from-record"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recordUri:t})})}async function st(t){return D(E(`/projects/${t}/materialize`),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dryRun:!1})})}const at=["todo","doing","blocked","done","canceled"];function nt({selectedProjectId:t,onSelectProject:n,contextLookup:i}){const[m,h]=a.useState([]),[k,j]=a.useState(!1),[y,S]=a.useState(null),[R,c]=a.useState(null),[p,g]=a.useState([]),[l,u]=a.useState(!1),[C,_]=a.useState(null),[x,N]=a.useState({}),[q,P]=a.useState({}),[I,W]=a.useState({}),[J,v]=a.useState({}),[d,o]=a.useState({}),[z,M]=a.useState(null);a.useEffect(()=>{B()},[]),a.useEffect(()=>{if(!t){c(null),g([]);return}K(t),H(t)},[t]);async function B(){j(!0),S(null);const b=await Qe();b.ok?h(b.data??[]):S(b.text||"Failed to load projects."),j(!1)}async function K(b){const w=await Xe(b);w.ok&&c(w.data??null)}async function H(b){u(!0),_(null);const w=await Ye(b);w.ok?g(w.data??[]):(_(w.text||"Failed to load tasks."),g([])),u(!1)}async function F(b,w){if(!t)return;o(U=>({...U,[b]:!0})),(await Ze(b,w)).ok&&await H(t),o(U=>({...U,[b]:!1}))}async function V(b){if(N(w=>({...w,[b]:!w[b]})),!q[b]){W($=>({...$,[b]:!0}));const w=await ke(b);w.ok&&P($=>({...$,[b]:w.data??[]})),W($=>({...$,[b]:!1}))}}async function Q(b){const w=J[b]?.trim();if(!w){M("Note body cannot be empty.");return}M(null);const $=await et(b,w);if($.ok){v(X=>({...X,[b]:""}));const U=await ke(b);U.ok&&P(X=>({...X,[b]:U.data??[]}))}else M($.text||"Failed to add note.")}const G=a.useMemo(()=>{const b={project:[],shared:[],deliverable:[]};return p.forEach(w=>{b[w.scope]?.push(w)}),b},[p]),te=a.useMemo(()=>{const b=new Map;return G.deliverable.forEach(w=>{const $=w.line_item_uri??"unknown",U=b.get($)??[];U.push(w),b.set($,U)}),b},[G.deliverable]),Y=a.useMemo(()=>{const b=new Map;return G.shared.forEach(w=>{const $=w.group_key??"ungrouped",U=b.get($)??[];U.push(w),b.set($,U)}),b},[G.shared]);return e.jsxs("section",{className:"x15ji50x",children:[e.jsx("h2",{children:"Projects"}),e.jsxs("div",{className:"xrvj5dj x14sj8ly xou54vl",children:[e.jsxs("div",{className:"x9hd93c xc7ga6q xht5q6y x78zum5 xdt5ytf x1v2ro7d",children:[e.jsx("div",{className:"x78zum5 x167g77z",children:e.jsx("button",{type:"button",onClick:B,disabled:k,children:k?"Loading...":"Refresh"})}),y&&e.jsx("div",{className:"x1tp81k5",children:y}),e.jsxs("ul",{className:"xe8uvvx x1717udv x1ghz6dp x78zum5 xdt5ytf x167g77z",children:[m.map(b=>e.jsx("li",{children:e.jsxs("button",{type:"button",className:{0:"xdpxx8g xh8yej3 xiq63ov x7z7khe xh2izcj x1ypdohk x78zum5 xdt5ytf x1jnr06f",1:"xdpxx8g xh8yej3 xiq63ov x7z7khe x1ypdohk x78zum5 xdt5ytf x1jnr06f x1hdarym x1tiokuu"}[(t===b.id)<<0],onClick:()=>n(b.id),children:[e.jsx("strong",{children:b.title}),e.jsx("span",{children:b.status}),e.jsx("span",{className:"xo8r7s1",children:b.updated_at??b.created_at})]})},b.id)),m.length===0&&!k&&e.jsx("li",{className:"xo8r7s1",children:"No projects yet."})]})]}),e.jsxs("div",{className:"x9hd93c x1tamke2 xht5q6y x78zum5 xdt5ytf x1v2ro7d",children:[!t&&e.jsx("p",{className:"xo8r7s1",children:"Select a project."}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"x78zum5 x6s0dn4 x1qughib x1v2ro7d",children:[e.jsxs("div",{children:[e.jsx("h3",{children:R?.title??"Project"}),e.jsxs("p",{className:"xo8r7s1",children:["Record: ",R?.commercial_record_uri??"n/a"]})]}),e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l xk61eof xiq63ov x1ypdohk",onClick:()=>n(null),children:"Back to list"})]}),C&&e.jsx("div",{className:"x1tp81k5",children:C}),l&&e.jsx("p",{className:"xo8r7s1",children:"Loading tasks..."}),!l&&e.jsxs("div",{className:"x78zum5 xdt5ytf xou54vl",children:[e.jsx(rt,{title:"Project",tasks:G.project,onStatusChange:F,statusSaving:d,onToggleNotes:V,expandedTasks:x,notesByTask:q,notesLoading:I,noteDrafts:J,setNoteDrafts:v,submitNote:Q,noteError:z}),e.jsx(be,{title:"Shared",groups:Y,contextLookup:i,onStatusChange:F,statusSaving:d,onToggleNotes:V,expandedTasks:x,notesByTask:q,notesLoading:I,noteDrafts:J,setNoteDrafts:v,submitNote:Q,noteError:z}),e.jsx(be,{title:"Deliverable",groups:te,contextLookup:i,onStatusChange:F,statusSaving:d,onToggleNotes:V,expandedTasks:x,notesByTask:q,notesLoading:I,noteDrafts:J,setNoteDrafts:v,submitNote:Q,noteError:z})]})]})]})]})]})}function rt({title:t,tasks:n,onStatusChange:i,statusSaving:m,onToggleNotes:h,expandedTasks:k,notesByTask:j,notesLoading:y,noteDrafts:S,setNoteDrafts:R,submitNote:c,noteError:p}){return n.length?e.jsxs("div",{className:"x78zum5 xdt5ytf x167g77z",children:[e.jsx("h4",{children:t}),n.map(g=>e.jsx(Re,{task:g,onStatusChange:i,statusSaving:m,onToggleNotes:h,expandedTasks:k,notesByTask:j,notesLoading:y,noteDrafts:S,setNoteDrafts:R,submitNote:c,noteError:p},g.id))]}):e.jsxs("div",{className:"x78zum5 xdt5ytf x167g77z",children:[e.jsx("h4",{children:t}),e.jsx("p",{className:"xo8r7s1",children:"No tasks."})]})}function be({title:t,groups:n,contextLookup:i,...m}){return e.jsxs("div",{className:"x78zum5 xdt5ytf x167g77z",children:[e.jsx("h4",{children:t}),n.size===0&&e.jsx("p",{className:"xo8r7s1",children:"No tasks."}),Array.from(n.entries()).map(([h,k])=>{const j=i?.[h]?.title;return e.jsxs("div",{className:"x9hd93c x7z7khe xh2izcj x78zum5 xdt5ytf x167g77z",children:[e.jsxs("div",{className:"x78zum5 xdt5ytf x1jnr06f",children:[e.jsx("strong",{children:j??Ne(h)}),j&&e.jsx("span",{className:"xo8r7s1",children:Ne(h)})]}),k.map(y=>e.jsx(Re,{task:y,...m},y.id))]},h)})]})}function Re({task:t,onStatusChange:n,statusSaving:i,onToggleNotes:m,expandedTasks:h,notesByTask:k,notesLoading:j,noteDrafts:y,setNoteDrafts:S,submitNote:R,noteError:c}){const p=h[t.id],g=k[t.id]??[],l=i[t.id];return e.jsxs("div",{className:"x9hd93c x7z7khe xht5q6y x78zum5 xdt5ytf x883omv",children:[e.jsxs("div",{className:"x78zum5 x1qughib x1v2ro7d x1a02dak",children:[e.jsxs("div",{children:[e.jsx("strong",{children:t.title}),e.jsx("div",{className:"xfifm61 x1e3jit",children:e.jsx("span",{children:t.template_key})})]}),e.jsxs("div",{className:"x78zum5 x167g77z x6s0dn4",children:[e.jsx("select",{value:t.status,onChange:u=>n(t.id,u.target.value),disabled:l,children:at.map(u=>e.jsx("option",{value:u,children:u},u))}),e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l xk61eof xiq63ov x1ypdohk",onClick:()=>m(t.id),children:p?"Hide notes":"Notes"})]})]}),p&&e.jsxs("div",{className:"x889kno x78zum5 xdt5ytf x167g77z",children:[j[t.id]&&e.jsx("p",{className:"xo8r7s1",children:"Loading notes..."}),c&&e.jsx("div",{className:"x1tp81k5",children:c}),g.length===0&&!j[t.id]&&e.jsx("p",{className:"xo8r7s1",children:"No notes yet."}),g.map(u=>e.jsxs("div",{className:"xur7f20 xe8ttls xh2izcj",children:[e.jsxs("div",{className:"x78zum5 x167g77z xfifm61 x1e3jit",children:[e.jsx("strong",{children:u.author_email}),e.jsx("span",{children:u.created_at})]}),e.jsx("p",{children:u.body})]},u.id)),e.jsx("textarea",{value:y[t.id]??"",onChange:u=>S(C=>({...C,[t.id]:u.target.value})),rows:3,placeholder:"Add a note..."}),e.jsx("button",{type:"button",onClick:()=>R(t.id),children:"Add note"})]})]})}function Ne(t,n=42){return t.length<=n?t:`${t.slice(0,18)}…${t.slice(-12)}`}function it(){return D(E("/templates"),{method:"GET"})}function lt(t){return D(E(`/templates/${encodeURIComponent(t)}`),{method:"GET"})}function dt(t){return D(E("/templates"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}function ot(t,n){return D(E(`/templates/${encodeURIComponent(t)}`),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}function ct(t){return D(E(`/templates/${encodeURIComponent(t)}`),{method:"DELETE"})}function xt(t,n){return D(E(`/templates/${encodeURIComponent(t)}/rules`),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}function ut(t,n,i){return D(E(`/templates/${encodeURIComponent(t)}/rules/${n}`),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}function ht(t,n){return D(E(`/templates/${encodeURIComponent(t)}/rules/${n}`),{method:"DELETE"})}const Se=`{
  "attach_to": "project"
}`,_e=["task","checklist","milestone"];function pt({selectedTemplateKeyOverride:t,onSelectedTemplateKeyChange:n}){const[i,m]=a.useState({}),[h,k]=a.useState(!1),[j,y]=a.useState({}),[S,R]=a.useState(!1),[c,p]=a.useState(null),[g,l]=a.useState(""),[u,C]=a.useState(""),[_,x]=a.useState({title:"",kind:"task",scope:"project",category_key:"",deliverable_key:"",default_position:"",default_state_json:"",is_active:!0}),[N,q]=a.useState({priority:"100",is_active:!0,match_json:Se}),[P,I]=a.useState({}),[W,J]=a.useState(!1),[v,d]=a.useState({key:"",title:"",kind:"task",scope:"project",category_key:"",deliverable_key:"",default_position:"",default_state_json:"",is_active:!0}),[o,z]=a.useState(!1),[M,B]=a.useState(!1),[K,H]=a.useState(!1),[F,V]=a.useState(!1),[Q,G]=a.useState(null),[te,Y]=a.useState(null),b=a.useCallback((s,r=!0)=>{l(s),r&&n?.(s)},[n]);a.useEffect(()=>{t!==void 0&&t!==g&&b(t||"",!1)},[g,t,b]);const w=a.useCallback(async()=>{k(!0),p(null);const s=await it();if(m({status:s.status,durationMs:s.durationMs,data:s.data??void 0,text:s.text,error:s.ok?void 0:ee(s,"Failed to load templates.")}),s.ok&&Array.isArray(s.data)){const r=s.data.map(f=>f.key);(!g||!r.includes(g))&&b(r[0]||"",!t)}k(!1)},[g,t,b]),$=a.useCallback(async s=>{if(!s){y({});return}R(!0),p(null);const r=await lt(s);y({status:r.status,durationMs:r.durationMs,data:r.data??void 0,text:r.text,error:r.ok?void 0:ee(r,"Failed to load template.")}),R(!1)},[]);a.useEffect(()=>{i.data||w()},[w,i.data]),a.useEffect(()=>{g&&$(g)},[$,g]),a.useEffect(()=>{if(!j.data)return;const s=j.data.template;x({title:s.title??"",kind:s.kind??"task",scope:s.scope??"project",category_key:s.category_key??"",deliverable_key:s.deliverable_key??"",default_position:s.default_position!==null&&s.default_position!==void 0?String(s.default_position):"",default_state_json:s.default_state_json??"",is_active:!!s.is_active});const r={};for(const f of j.data.rules??[])r[f.id]={priority:String(f.priority??""),is_active:!!f.is_active,match_json:f.match_json??""};I(r)},[j.data]);const U=a.useMemo(()=>i.data??[],[i.data]),X=a.useMemo(()=>{const s=u.trim().toLowerCase();return s?U.filter(r=>r.key.toLowerCase().includes(s)||r.title.toLowerCase().includes(s)||r.scope.toLowerCase().includes(s)):U},[U,u]),L=j.data,ie=L?.rules??[];async function oe(){if(!v.key.trim()||!v.title.trim()){p("Template key and title are required.");return}const s=ze(v.default_state_json);if(s.error){p("Default state JSON must be valid.");return}H(!0),p(null);const r=await dt({key:v.key.trim(),title:v.title.trim(),kind:v.kind,scope:v.scope,category_key:v.category_key||void 0,deliverable_key:v.deliverable_key||void 0,default_state_json:s.value,default_position:we(v.default_position),is_active:v.is_active});if(!r.ok){p(ee(r,"Failed to create template.")),H(!1);return}J(!1),d({key:"",title:"",kind:"task",scope:"project",category_key:"",deliverable_key:"",default_position:"",default_state_json:"",is_active:!0}),r.data?.template?.key&&(b(r.data.template.key),y({status:r.status,durationMs:r.durationMs,data:r.data,text:r.text})),await w(),H(!1)}async function ce(){if(!L?.template?.key)return;const s=ze(_.default_state_json);if(s.error){p("Default state JSON must be valid.");return}z(!0),p(null);const r=await ot(L.template.key,{title:_.title,kind:_.kind,scope:_.scope,category_key:_.category_key||null,deliverable_key:_.deliverable_key||null,default_state_json:s.value,default_position:we(_.default_position),is_active:_.is_active});if(!r.ok){p(ee(r,"Failed to update template.")),z(!1);return}y({status:r.status,durationMs:r.durationMs,data:r.data??void 0,text:r.text}),await w(),z(!1)}async function xe(){if(!L?.template?.key||!confirm(`Delete template ${L.template.key}?`))return;B(!0),p(null);const s=await ct(L.template.key);if(!s.ok){p(ee(s,"Failed to delete template.")),B(!1);return}y({}),b(""),await w(),B(!1)}async function ue(){if(!L?.template?.key)return;V(!0),p(null);const s=Number(N.priority);if(Number.isNaN(s)){p("Rule priority must be a number."),V(!1);return}const r=await xt(L.template.key,{priority:s,match_json:N.match_json,is_active:N.is_active});if(!r.ok){p(ee(r,"Failed to create rule.")),V(!1);return}q({priority:"100",is_active:!0,match_json:Se}),await $(L.template.key),V(!1)}async function he(s){if(!L?.template?.key)return;const r=P[s.id];if(!r)return;const f=Number(r.priority);if(Number.isNaN(f)){p("Rule priority must be a number.");return}G(s.id),p(null);const T=await ut(L.template.key,s.id,{priority:f,match_json:r.match_json,is_active:r.is_active});if(!T.ok){p(ee(T,"Failed to update rule.")),G(null);return}await $(L.template.key),G(null)}async function pe(s){if(!L?.template?.key||!confirm(`Delete rule ${s.id}?`))return;Y(s.id),p(null);const r=await ht(L.template.key,s.id);if(!r.ok){p(ee(r,"Failed to delete rule.")),Y(null);return}await $(L.template.key),Y(null)}function ne(s,r){I(f=>({...f,[s]:{...f[s],...r}}))}return e.jsxs("div",{className:"x78zum5 xdt5ytf xou54vl",children:[e.jsxs("div",{className:"x78zum5 x1qughib x1v2ro7d x1a02dak",children:[e.jsxs("div",{className:"x78zum5 x6s0dn4 x167g77z",children:[e.jsx("label",{htmlFor:"template-search",children:"Search templates"}),e.jsx("input",{id:"template-search",type:"text",placeholder:"Filter by key, title, scope",value:u,onChange:s=>C(s.target.value)})]}),e.jsxs("div",{className:"x78zum5 x6s0dn4 x167g77z x1a02dak",children:[e.jsx("button",{type:"button",onClick:w,disabled:h,children:h?"Refreshing...":"Refresh"}),e.jsx("button",{type:"button",onClick:()=>J(!0),children:"New Template"})]})]}),i.error&&e.jsx("div",{className:"x1tp81k5",children:i.error}),c&&e.jsx("div",{className:"x1tp81k5",children:c}),e.jsxs("div",{className:"xrvj5dj x1jptsyt xou54vl",children:[e.jsxs("div",{className:"xur7f20 xc7ga6q xht5q6y x78zum5 xdt5ytf x167g77z",children:[e.jsxs("div",{className:"x1s688f",children:[e.jsx("strong",{children:"Templates"}),e.jsxs("span",{children:[X.length," shown"]})]}),X.length===0&&e.jsx("div",{className:"xo8r7s1",children:"No templates found."}),X.map(s=>{const r=s.key===g;return e.jsxs("button",{type:"button",className:{0:"xur7f20 x7z7khe xh2izcj xdpxx8g x1ypdohk",1:"xur7f20 x7z7khe xdpxx8g x1ypdohk x1hdarym x1tja46j"}[!!r<<0],onClick:()=>b(s.key),children:[e.jsx("div",{className:"x1s688f",children:s.key}),e.jsxs("div",{className:"x78zum5 x17d4w8g x1a02dak xfifm61 x1e3jit",children:[e.jsx("span",{children:s.title}),e.jsxs("span",{children:[s.kind," · ",s.scope,s.category_key?` · ${s.category_key}`:"",s.deliverable_key?`/${s.deliverable_key}`:""]}),e.jsx("span",{className:{0:"x1tp81k5 x1s688f",1:"x3ycguq x1s688f"}[!!s.is_active<<0],children:s.is_active?"active":"inactive"})]})]},s.key)})]}),e.jsxs("div",{className:"xur7f20 xc7ga6q xht5q6y x78zum5 xdt5ytf x1v2ro7d",children:[e.jsxs("div",{className:"x78zum5 x1qughib x167g77z x1a02dak",children:[e.jsx("strong",{children:"Template Editor"}),j.status!==void 0&&e.jsxs("span",{className:"xfifm61 xo8r7s1",children:["Status ",j.status," · ",j.durationMs,"ms"]})]}),S&&e.jsx("div",{className:"xo8r7s1",children:"Loading template details..."}),j.error&&e.jsx("div",{className:"x1tp81k5",children:j.error}),!L&&!S&&e.jsx("div",{className:"xo8r7s1",children:"Select a template to edit."}),L&&e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"x1xmf6yo x78zum5 xdt5ytf x1v2ro7d",children:[e.jsx("h3",{children:"Template"}),e.jsxs("div",{className:"xrvj5dj x1v2ro7d",children:[e.jsxs("label",{children:["Key",e.jsx("input",{type:"text",value:L.template.key,disabled:!0})]}),e.jsxs("label",{children:["Title",e.jsx("input",{type:"text",value:_.title,onChange:s=>x(r=>({...r,title:s.target.value}))})]}),e.jsxs("label",{children:["Kind",e.jsx("select",{value:_.kind,onChange:s=>x(r=>({...r,kind:s.target.value})),children:_e.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("label",{children:["Scope",e.jsxs("select",{value:_.scope,onChange:s=>x(r=>({...r,scope:s.target.value})),children:[e.jsx("option",{value:"project",children:"project"}),e.jsx("option",{value:"shared",children:"shared"}),e.jsx("option",{value:"deliverable",children:"deliverable"})]})]}),e.jsxs("label",{children:["Category Key",e.jsx("input",{type:"text",value:_.category_key,onChange:s=>x(r=>({...r,category_key:s.target.value}))})]}),e.jsxs("label",{children:["Deliverable Key",e.jsx("input",{type:"text",value:_.deliverable_key,onChange:s=>x(r=>({...r,deliverable_key:s.target.value}))})]}),e.jsxs("label",{children:["Default Position",e.jsx("input",{type:"number",value:_.default_position,onChange:s=>x(r=>({...r,default_position:s.target.value}))})]}),e.jsxs("label",{className:"x3nfvp2 x17d4w8g x6s0dn4",children:[e.jsx("input",{type:"checkbox",checked:_.is_active,onChange:s=>x(r=>({...r,is_active:s.target.checked}))}),"Active"]})]}),e.jsxs("details",{className:"xur7f20 x7z7khe",children:[e.jsx("summary",{children:"Advanced: Default State JSON"}),e.jsx("textarea",{rows:6,value:_.default_state_json,onChange:s=>x(r=>({...r,default_state_json:s.target.value}))})]}),e.jsxs("div",{className:"x78zum5 x6s0dn4 x167g77z x1a02dak",children:[e.jsx("button",{type:"button",onClick:ce,disabled:o,children:o?"Saving...":"Save Template"}),e.jsx("button",{type:"button",className:"x1el1eiv x1tp81k5 xk61eof xur7f20 x1ypdohk",onClick:xe,disabled:M,children:M?"Deleting...":"Delete Template"})]})]}),e.jsxs("section",{className:"x1xmf6yo x78zum5 xdt5ytf x1v2ro7d",children:[e.jsx("h3",{children:"Rules"}),e.jsxs("div",{className:"xur7f20 x7z7khe xh2izcj",children:[e.jsxs("label",{children:["Priority",e.jsx("input",{type:"number",value:N.priority,onChange:s=>q(r=>({...r,priority:s.target.value}))})]}),e.jsxs("label",{className:"x3nfvp2 x17d4w8g x6s0dn4",children:[e.jsx("input",{type:"checkbox",checked:N.is_active,onChange:s=>q(r=>({...r,is_active:s.target.checked}))}),"Active"]}),e.jsxs("label",{className:"x78zum5 xdt5ytf x17d4w8g",children:["Match JSON",e.jsx("textarea",{rows:4,value:N.match_json,onChange:s=>q(r=>({...r,match_json:s.target.value}))})]}),e.jsx("button",{type:"button",onClick:ue,disabled:F,children:F?"Creating...":"Create Rule"})]}),ie.length===0&&e.jsx("div",{className:"xo8r7s1",children:"No rules yet."}),e.jsx("div",{className:"x78zum5 xdt5ytf x883omv",children:ie.map(s=>{const r=P[s.id],f=mt(s.match_json);return e.jsxs("div",{className:"xur7f20 x7z7khe xht5q6y",children:[e.jsxs("div",{className:"x78zum5 x167g77z x6s0dn4 x1e56ztr",children:[e.jsxs("strong",{children:["Rule ",s.id]}),f&&e.jsx("span",{className:"x1dumkz1 xur7f20 x1j6dyjg x1tiokuu xw5m2i1",children:f})]}),e.jsxs("div",{className:"xrvj5dj x1v2ro7d",children:[e.jsxs("label",{children:["Priority",e.jsx("input",{type:"number",value:r?.priority??"",onChange:T=>ne(s.id,{priority:T.target.value})})]}),e.jsxs("label",{className:"x3nfvp2 x17d4w8g x6s0dn4",children:[e.jsx("input",{type:"checkbox",checked:r?.is_active??!1,onChange:T=>ne(s.id,{is_active:T.target.checked})}),"Active"]}),e.jsxs("label",{className:"x78zum5 xdt5ytf x17d4w8g",children:["Match JSON",e.jsx("textarea",{rows:4,value:r?.match_json??"",onChange:T=>ne(s.id,{match_json:T.target.value})})]})]}),e.jsxs("div",{className:"x78zum5 x6s0dn4 x167g77z x1a02dak",children:[e.jsx("button",{type:"button",onClick:()=>he(s),disabled:Q===s.id,children:Q===s.id?"Saving...":"Save"}),e.jsx("button",{type:"button",className:"x1el1eiv x1tp81k5 xk61eof xur7f20 x1ypdohk",onClick:()=>pe(s),disabled:te===s.id,children:te===s.id?"Deleting...":"Delete"})]})]},s.id)})})]}),e.jsxs("section",{className:"x1xmf6yo x78zum5 xdt5ytf x1v2ro7d",children:[e.jsx("h3",{children:"Raw JSON"}),e.jsx("div",{className:"xur7f20 x7z7khe xh2izcj",children:e.jsx(de,{data:L})})]})]})]})]}),W&&e.jsx("div",{className:"xixxii4 x10a8y8t x1i66cv5 x78zum5 x6s0dn4 xl56j7k xggk2y7",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"xht5q6y xur7f20 x1qhigcl xoww62b",children:[e.jsx("h3",{children:"New Template"}),e.jsxs("div",{className:"xrvj5dj x1v2ro7d",children:[e.jsxs("label",{children:["Key",e.jsx("input",{type:"text",value:v.key,onChange:s=>d(r=>({...r,key:s.target.value}))})]}),e.jsxs("label",{children:["Title",e.jsx("input",{type:"text",value:v.title,onChange:s=>d(r=>({...r,title:s.target.value}))})]}),e.jsxs("label",{children:["Kind",e.jsx("select",{value:v.kind,onChange:s=>d(r=>({...r,kind:s.target.value})),children:_e.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("label",{children:["Scope",e.jsxs("select",{value:v.scope,onChange:s=>d(r=>({...r,scope:s.target.value})),children:[e.jsx("option",{value:"project",children:"project"}),e.jsx("option",{value:"shared",children:"shared"}),e.jsx("option",{value:"deliverable",children:"deliverable"})]})]}),v.scope==="deliverable"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{children:["Category Key",e.jsx("input",{type:"text",value:v.category_key,onChange:s=>d(r=>({...r,category_key:s.target.value}))})]}),e.jsxs("label",{children:["Deliverable Key",e.jsx("input",{type:"text",value:v.deliverable_key,onChange:s=>d(r=>({...r,deliverable_key:s.target.value}))})]})]}),e.jsxs("label",{children:["Default Position",e.jsx("input",{type:"number",value:v.default_position,onChange:s=>d(r=>({...r,default_position:s.target.value}))})]}),e.jsxs("label",{className:"x3nfvp2 x17d4w8g x6s0dn4",children:[e.jsx("input",{type:"checkbox",checked:v.is_active,onChange:s=>d(r=>({...r,is_active:s.target.checked}))}),"Active"]})]}),e.jsxs("details",{className:"xur7f20 x7z7khe",children:[e.jsx("summary",{children:"Advanced: Default State JSON"}),e.jsx("textarea",{rows:6,value:v.default_state_json,onChange:s=>d(r=>({...r,default_state_json:s.target.value}))})]}),e.jsxs("div",{className:"x78zum5 x6s0dn4 x167g77z x1a02dak",children:[e.jsx("button",{type:"button",onClick:oe,disabled:K,children:K?"Creating...":"Create"}),e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l xk61eof xur7f20 x1ypdohk",onClick:()=>J(!1),children:"Cancel"})]})]})})]})}function ee(t,n){if(t.data&&typeof t.data=="object"){const i=t.data;if(i.error)return i.details?`${i.error}: ${JSON.stringify(i.details)}`:i.error}return t.text?t.text:n}function mt(t){try{return JSON.parse(t).attach_to||""}catch{return""}}function ze(t){if(!t.trim())return{value:null,error:!1};try{return{value:JSON.parse(t),error:!1}}catch{return{value:null,error:!0}}}function we(t){if(!t.trim())return null;const n=Number(t);return Number.isInteger(n)?n:null}async function jt(t){return D(E("/integrations",t?{workspaceId:t}:void 0))}async function ft(t){return D(E("/integrations"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async function Ce(t,n){return D(E(`/integrations/${t}`),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}async function yt(t){return D(E(`/integrations/${t}`),{method:"DELETE"})}const vt=[{value:"shopify",label:"Shopify"},{value:"qbo",label:"QuickBooks"}],gt=["sandbox","production"];function kt({workspaceId:t,workspaces:n}){const[i,m]=a.useState([]),[h,k]=a.useState(!1),[j,y]=a.useState(null),[S,R]=a.useState("shopify"),[c,p]=a.useState("production"),[g,l]=a.useState(""),[u,C]=a.useState(""),[_,x]=a.useState(""),[N,q]=a.useState({}),P=a.useCallback(async()=>{k(!0),y(null);const d=await jt(t);d.ok?m(d.data??[]):y(d.text||"Failed to load integrations."),k(!1)},[t]);a.useEffect(()=>{P()},[P]);async function I(){if(!t){y("Select a workspace first.");return}const o=await ft({workspaceId:t,provider:S,environment:c,externalAccountId:g,displayName:u,secrets:S==="shopify"?{webhookSecret:_}:{webhookVerifierToken:_}});if(!o.ok){y(o.text||"Failed to create integration.");return}l(""),C(""),x(""),await P()}async function W(d){await Ce(d.id,{is_active:d.is_active?0:1}),await P()}async function J(d){const o=N[d.id]?.trim();if(!o)return;const z=d.provider==="shopify"?{webhookSecret:o}:{webhookVerifierToken:o};await Ce(d.id,{secrets:z}),q(M=>({...M,[d.id]:""})),await P()}async function v(d){await yt(d),await P()}return e.jsxs("section",{className:"x15ji50x",children:[e.jsx("h2",{children:"Integrations"}),e.jsxs("p",{className:"xo8r7s1",children:["Webhook endpoints:",e.jsx("br",{}),"Shopify: ",e.jsx("code",{children:"https://api.from-trees.com/ingest/shopify/webhook?env=production"}),e.jsx("br",{}),"QBO: ",e.jsx("code",{children:"https://api.from-trees.com/ingest/qbo/webhook?env=production"})]}),e.jsxs("div",{className:"xw7yly9",children:[e.jsx("h3",{children:"Create Integration"}),e.jsxs("div",{className:"xrvj5dj x1v2ro7d",children:[e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"Workspace"}),e.jsx("select",{value:t??"",onChange:()=>{},disabled:!0,children:n.map(d=>e.jsx("option",{value:d.id,children:d.name},d.id))})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"Provider"}),e.jsx("select",{value:S,onChange:d=>R(d.target.value),children:vt.map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"Environment"}),e.jsx("select",{value:c,onChange:d=>p(d.target.value),children:gt.map(d=>e.jsx("option",{value:d,children:d},d))})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"External account ID"}),e.jsx("input",{value:g,onChange:d=>l(d.target.value),placeholder:S==="shopify"?"shop.myshopify.com":"realmId"})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"Display name"}),e.jsx("input",{value:u,onChange:d=>C(d.target.value),placeholder:"Optional label"})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:S==="shopify"?"Webhook secret":"Webhook verifier token"}),e.jsx("input",{value:_,onChange:d=>x(d.target.value),placeholder:"Secret"})]})]}),e.jsx("div",{className:"x78zum5 x1a02dak x167g77z x1anpbxc",children:e.jsx("button",{type:"button",onClick:I,children:"Save integration"})}),j&&e.jsx("div",{className:"x1tp81k5",children:j})]}),e.jsxs("div",{className:"xw7yly9",children:[e.jsx("h3",{children:"Existing Integrations"}),h&&e.jsx("p",{className:"xo8r7s1",children:"Loading..."}),i.length===0&&!h&&e.jsx("p",{className:"xo8r7s1",children:"None yet."}),e.jsx("div",{className:"x9hd93c xw2csxc",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Provider"}),e.jsx("th",{children:"Env"}),e.jsx("th",{children:"Account"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Active"}),e.jsx("th",{children:"Secrets"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:i.map(d=>e.jsxs("tr",{children:[e.jsx("td",{children:d.provider}),e.jsx("td",{children:d.environment}),e.jsx("td",{children:d.external_account_id}),e.jsx("td",{children:d.display_name??"-"}),e.jsx("td",{children:d.is_active?"yes":"no"}),e.jsx("td",{children:e.jsx("input",{value:N[d.id]??"",onChange:o=>q(z=>({...z,[d.id]:o.target.value})),placeholder:"Replace secret"})}),e.jsxs("td",{children:[e.jsx("button",{type:"button",onClick:()=>J(d),children:"Save secret"}),e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l xk61eof xiq63ov x1ypdohk x16vho4v",onClick:()=>W(d),children:d.is_active?"Disable":"Enable"}),e.jsx("button",{type:"button",className:"x1el1eiv x1tp81k5 xk61eof xiq63ov x1ypdohk x16vho4v",onClick:()=>v(d.id),children:"Delete"})]})]},d.id))})]})})]})]})}async function bt(t){return D(E("/ingest/requests",t))}async function Nt(t){return D(E(`/ingest/requests/${t}`))}const St=["shopify","qbo"],_t=["production","sandbox"];function zt({workspaceId:t,workspaces:n}){const[i,m]=a.useState("shopify"),[h,k]=a.useState("production"),[j,y]=a.useState([]),[S,R]=a.useState(null),[c,p]=a.useState(null),[g,l]=a.useState(!1),u=new Map(n.map(x=>[x.id,x.name])),C=a.useCallback(async()=>{l(!0),p(null);const x=await bt({provider:i,environment:h,workspaceId:t??void 0,limit:50});x.ok?(y(x.data?.requests??[]),R(null)):p(x.text||"Failed to load ingest requests."),l(!1)},[h,i,t]);a.useEffect(()=>{C()},[C]);async function _(x){const N=await Nt(x);N.ok?R(N.data??null):p(N.text||"Failed to load detail.")}return e.jsxs("section",{className:"x15ji50x",children:[e.jsx("h2",{children:"Ingest"}),e.jsxs("div",{className:"x78zum5 x167g77z x1a02dak x6s0dn4",children:[e.jsx("select",{value:i,onChange:x=>m(x.target.value),children:St.map(x=>e.jsx("option",{value:x,children:x},x))}),e.jsx("select",{value:h,onChange:x=>k(x.target.value),children:_t.map(x=>e.jsx("option",{value:x,children:x},x))}),e.jsx("select",{value:t??"",onChange:()=>{},disabled:!0,children:n.map(x=>e.jsx("option",{value:x.id,children:x.name},x.id))}),e.jsx("button",{type:"button",onClick:C,disabled:g,children:g?"Loading...":"Refresh"})]}),c&&e.jsx("div",{className:"x1tp81k5",children:c}),e.jsxs("div",{className:"xrvj5dj xzi7dhk xou54vl xw7yly9",children:[e.jsx("div",{className:"x9hd93c xw2csxc xht5q6y",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"received_at"}),e.jsx("th",{children:"workspace"}),e.jsx("th",{children:"integration"}),e.jsx("th",{children:"routed"}),e.jsx("th",{children:"verified"}),e.jsx("th",{children:"topic"}),e.jsx("th",{children:"shop"}),e.jsx("th",{children:"webhook_id"}),e.jsx("th",{children:"error"})]})}),e.jsxs("tbody",{children:[j.map(x=>e.jsxs("tr",{onClick:()=>_(x.id),children:[e.jsx("td",{children:x.received_at}),e.jsx("td",{children:u.get(x.workspace_id)??x.workspace_id}),e.jsx("td",{children:x.integration_display_name??"-"}),e.jsx("td",{children:x.integration_id?"yes":"no"}),e.jsx("td",{children:x.signature_verified?"yes":"no"}),e.jsx("td",{children:x.topic??"-"}),e.jsx("td",{children:x.shop_domain??"-"}),e.jsx("td",{children:x.webhook_id??"-"}),e.jsx("td",{children:x.verify_error??"-"})]},x.id)),j.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"xo8r7s1",children:"No requests."})})]})]})}),e.jsx("div",{className:"x9hd93c xc7ga6q xht5q6y",children:S?e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"Request Detail"}),e.jsx("pre",{children:JSON.stringify(S,null,2)})]}):e.jsx("p",{className:"xo8r7s1",children:"Select a request to inspect."})})]})]})}async function Ee(){return D(E("/workspaces"))}async function wt(t){return D(E("/workspaces"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async function Ct(t,n){return D(E(`/workspaces/${t}`),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}async function qt(t){return D(E(`/workspaces/${t}`),{method:"DELETE"})}const qe=/^[a-z0-9-]{3,40}$/;function Tt({selectedWorkspaceId:t,onSelectWorkspace:n}){const[i,m]=a.useState([]),[h,k]=a.useState(!1),[j,y]=a.useState(null),[S,R]=a.useState(""),[c,p]=a.useState(""),[g,l]=a.useState(null),[u,C]=a.useState(""),[_,x]=a.useState(""),[N,q]=a.useState(null);a.useEffect(()=>{P()},[]);async function P(){k(!0),y(null);const v=await Ee();v.ok?m(v.data??[]):y(v.text||"Failed to load workspaces."),k(!1)}async function I(){if(!qe.test(S)){y("Slug must be 3-40 chars: lowercase letters, digits, hyphens.");return}if(!c.trim()){y("Name is required.");return}const v=await wt({slug:S,name:c});if(!v.ok){y(v.text||"Failed to create workspace.");return}R(""),p(""),await P()}async function W(){if(!g)return;if(u&&!qe.test(u)){y("Slug must be 3-40 chars: lowercase letters, digits, hyphens.");return}const v=await Ct(g.id,{slug:u||g.slug||void 0,name:_||g.name});if(!v.ok){y(v.text||"Failed to update workspace.");return}l(null),C(""),x(""),await P()}async function J(v){if(!confirm(`Delete workspace ${v.slug}?`))return;q(null);const d=await qt(v.id);if(!d.ok){let o=d.text||"Delete failed.";if(d.data&&typeof d.data=="object"){const z=d.data;z.error==="workspace_not_empty"&&z.counts&&(o=`Workspace not empty. ${Object.entries(z.counts).map(([B,K])=>`${B}: ${K}`).join(", ")}`),z.error==="cannot_delete_default_workspace"&&(o="Default workspace cannot be deleted.")}q(o);return}t===v.id&&n(null),await P()}return e.jsxs("section",{className:"x15ji50x",children:[e.jsx("h2",{children:"Workspaces"}),j&&e.jsx("div",{className:"x1tp81k5",children:j}),N&&e.jsx("div",{className:"x1tp81k5",children:N}),e.jsxs("div",{className:"xw7yly9",children:[e.jsx("h3",{children:"Create Workspace"}),e.jsxs("div",{className:"xrvj5dj x1v2ro7d",children:[e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"Slug"}),e.jsx("input",{value:S,onChange:v=>R(v.target.value),placeholder:"acme-production"})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"Name"}),e.jsx("input",{value:c,onChange:v=>p(v.target.value),placeholder:"Acme Production"})]})]}),e.jsx("div",{className:"x78zum5 x167g77z x1anpbxc x1a02dak",children:e.jsx("button",{type:"button",onClick:I,children:"Create"})})]}),e.jsxs("div",{className:"xw7yly9",children:[e.jsx("h3",{children:"Existing Workspaces"}),h&&e.jsx("p",{className:"xo8r7s1",children:"Loading..."}),e.jsx("div",{className:"xur7f20 xw2csxc",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"slug"}),e.jsx("th",{children:"name"}),e.jsx("th",{children:"created"}),e.jsx("th",{children:"updated"}),e.jsx("th",{children:"actions"})]})}),e.jsxs("tbody",{children:[i.map(v=>e.jsxs("tr",{children:[e.jsx("td",{children:v.slug??"-"}),e.jsx("td",{children:v.name}),e.jsx("td",{children:v.created_at??"-"}),e.jsx("td",{children:v.updated_at??"-"}),e.jsxs("td",{children:[e.jsx("button",{type:"button",onClick:()=>{l(v),C(v.slug??""),x(v.name)},children:"Edit"}),e.jsx("button",{type:"button",className:"x1el1eiv x1tp81k5 xk61eof xur7f20 x1ypdohk x16vho4v",onClick:()=>J(v),children:"Delete"})]})]},v.id)),i.length===0&&!h&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"xo8r7s1",children:"No workspaces yet."})})]})]})})]}),g&&e.jsx("div",{className:"xixxii4 x10a8y8t x1i66cv5 x78zum5 x6s0dn4 xl56j7k xggk2y7",children:e.jsxs("div",{className:"xht5q6y xur7f20 x1qhigcl x1cy49o3",children:[e.jsx("h3",{children:"Edit Workspace"}),e.jsxs("div",{className:"xrvj5dj x1v2ro7d",children:[e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"Slug"}),e.jsx("input",{value:u,onChange:v=>C(v.target.value)})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{children:"Name"}),e.jsx("input",{value:_,onChange:v=>x(v.target.value)})]})]}),e.jsxs("div",{className:"x78zum5 x167g77z x1anpbxc x1a02dak",children:[e.jsx("button",{type:"button",onClick:W,children:"Save"}),e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l xk61eof xur7f20 x1ypdohk",onClick:()=>l(null),children:"Cancel"})]})]})})]})}const Rt=["manual://proposal/demo","shopify://order/example","qbo://invoice/example"],Pe=a.createContext(null);function ae(){const t=a.useContext(Pe);if(!t)throw new Error("useAppState must be used within AppContext provider.");return t}function Dt(){const t=re(),[n,i]=a.useState(""),[m,h]=a.useState(!0),[k,j]=a.useState({}),[y,S]=a.useState(!1),[R,c]=a.useState(null),[p,g]=a.useState(!1),[l,u]=a.useState({}),[C,_]=a.useState(!1),[x,N]=a.useState(null),[q,P]=a.useState("manual"),[I,W]=a.useState("preview"),[J,v]=a.useState("example-1"),[d,o]=a.useState(`{
  "hello": "world"
}`),[z,M]=a.useState({}),[B,K]=a.useState(!1),[H,F]=a.useState(null),[V,Q]=a.useState(""),[G,te]=a.useState([]),[Y,b]=a.useState(!1),[w,$]=a.useState(null);a.useEffect(()=>{},[V]);const U=a.useCallback(async()=>{b(!0);const f=await Ee();if(f.ok&&f.data&&(te(f.data),!(w?f.data.some(O=>O.id===w):!1))){const O=f.data.find(A=>A.slug==="default")??f.data[0];$(O?.id??null)}b(!1)},[w]);a.useEffect(()=>{U()},[U]);const X=a.useMemo(()=>n.trim()?E("/plan/preview",{record_uri:n.trim()}):"",[n]),L=a.useMemo(()=>!k.data||typeof k.data!="object"?{}:(k.data.contexts?.deliverables??[]).reduce((O,A)=>(A?.key&&(O[A.key]={title:A.title??null}),O),{}),[k.data]);async function ie(f){const T=(f??n).trim();if(!T){j({error:"Record URI is required."});return}f!==void 0&&i(f);const O=E("/plan/preview",{record_uri:T});S(!0),j({url:O});try{const A=await D(O,{method:"GET"});j({url:O,status:A.status,durationMs:A.durationMs,data:A.data??void 0,text:A.text,error:A.ok?A.data===null&&A.text?"Response was not valid JSON.":void 0:`Request failed with status ${A.status}.`})}catch(A){j({url:O,error:A instanceof Error?A.message:"Failed to fetch preview."})}finally{S(!1)}}async function oe(){const f=n.trim();if(!f){c("Record URI is required.");return}g(!0),c(null);try{const T=await tt(f);if(!T.ok||!T.data){c(T.text||"Failed to create project.");return}const O=T.data.project.id,A=await st(O);if(!A.ok||!A.data){c(A.text||"Failed to materialize tasks.");return}const{alreadyMaterialized:De,tasksCreated:Ie}=A.data;c(De?"Already materialized (no changes).":`Created ${Ie} tasks.`),F(O),t("/projects")}catch(T){c(T instanceof Error?T.message:"Materialize failed.")}finally{g(!1)}}async function ce(){const f=E("/events");_(!0),u({url:f}),N(null);try{const T=await D(f,{method:"GET",credentials:"include"});u({url:f,status:T.status,durationMs:T.durationMs,data:T.data??void 0,text:T.text,error:T.ok?T.data===null&&T.text?"Response was not valid JSON.":void 0:`Request failed with status ${T.status}.`})}catch(T){u({url:f,error:T instanceof Error?T.message:"Failed to load events."})}finally{_(!1)}}async function xe(){const f=E("/events/test");K(!0),M({url:f});let T;try{T=d.trim()?JSON.parse(d):{}}catch{M({url:f,error:"Payload must be valid JSON."}),K(!1);return}try{const O=await D(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source:q,type:I,externalId:J,payload:T})});M({url:f,status:O.status,durationMs:O.durationMs,data:O.data??void 0,text:O.text,error:O.ok?O.data===null&&O.text?"Response was not valid JSON.":void 0:`Request failed with status ${O.status}.`})}catch(O){M({url:f,error:O instanceof Error?O.message:"Failed to post test event."})}finally{K(!1)}}const ue=typeof k.data=="object"&&k.data?k.data.plan_id:void 0,he=typeof k.data=="object"&&k.data?k.data.warnings:void 0,pe=typeof z.data=="object"&&z.data?z.data.idempotencyKey||z.data.idempotency_key:void 0,ne=Array.isArray(l.data)?l.data:Array.isArray(l.data?.events)?l.data.events??[]:[];async function s(f,T){try{await navigator.clipboard.writeText(T),alert(`${f} copied to clipboard.`)}catch{alert("Copy failed. Please copy manually.")}}const r={recordUri:n,setRecordUri:i,autoRunOnSelect:m,setAutoRunOnSelect:h,previewState:k,previewLoading:y,materializeMessage:R,materializeLoading:p,runPreview:ie,materializeTasks:oe,previewUrl:X,planId:ue,warnings:he,contextLookup:L,eventsState:l,eventsLoading:C,refreshEvents:ce,expandedRowIndex:x,setExpandedRowIndex:N,events:ne,testSource:q,setTestSource:P,testType:I,setTestType:W,testExternalId:J,setTestExternalId:v,testPayload:d,setTestPayload:o,testState:z,testLoading:B,runEventsTest:xe,idempotencyKey:pe,copyToClipboard:s,selectedProjectId:H,setSelectedProjectId:F,debugEmail:V,setDebugEmail:Q,workspaces:G,workspaceLoading:Y,selectedWorkspaceId:w,setSelectedWorkspaceId:$};return e.jsx(Pe.Provider,{value:r,children:e.jsxs("div",{className:"xg6iff7 x7e92ml xvqfk9l x17i4hy",children:[e.jsxs("header",{className:"x78zum5 x1cy8zhl x1qughib x1vxykrk x1opzaxk xht5q6y",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"ftops internal UI"}),e.jsx("p",{children:"Plan preview + events viewer for ftops endpoints."})]}),e.jsxs("div",{className:"x78zum5 xou54vl xuk3077 x1a02dak",children:[e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{htmlFor:"workspace-select",children:"Workspace"}),e.jsx("select",{id:"workspace-select",value:w??"",onChange:f=>$(f.target.value),disabled:Y,children:G.map(f=>e.jsx("option",{value:f.id,children:f.name},f.id))})]}),!1]})]}),e.jsx(Me,{}),e.jsxs("nav",{className:"x78zum5 x15668s1 x132eafk x1a02dak",children:[e.jsx(Z,{className:({isActive:f})=>({0:"xh2izcj x1e3jit xbnpv00 xur7f20 x1ypdohk x4z9k3i",1:"xbnpv00 xur7f20 x1ypdohk x4z9k3i xvz32qw xmfno27 x1hdarym"})[!!f<<0],to:"/plan-preview",children:"Plan Preview"}),e.jsx(Z,{className:({isActive:f})=>({0:"xh2izcj x1e3jit xbnpv00 xur7f20 x1ypdohk x4z9k3i",1:"xbnpv00 xur7f20 x1ypdohk x4z9k3i xvz32qw xmfno27 x1hdarym"})[!!f<<0],to:"/events",children:"Events Viewer"}),e.jsx(Z,{className:({isActive:f})=>({0:"xh2izcj x1e3jit xbnpv00 xur7f20 x1ypdohk x4z9k3i",1:"xbnpv00 xur7f20 x1ypdohk x4z9k3i xvz32qw xmfno27 x1hdarym"})[!!f<<0],to:"/demo",children:"Demo"}),e.jsx(Z,{className:({isActive:f})=>({0:"xh2izcj x1e3jit xbnpv00 xur7f20 x1ypdohk x4z9k3i",1:"xbnpv00 xur7f20 x1ypdohk x4z9k3i xvz32qw xmfno27 x1hdarym"})[!!f<<0],to:"/templates",children:"Templates"}),e.jsx(Z,{className:({isActive:f})=>({0:"xh2izcj x1e3jit xbnpv00 xur7f20 x1ypdohk x4z9k3i",1:"xbnpv00 xur7f20 x1ypdohk x4z9k3i xvz32qw xmfno27 x1hdarym"})[!!f<<0],to:"/projects",children:"Projects"}),e.jsx(Z,{className:({isActive:f})=>({0:"xh2izcj x1e3jit xbnpv00 xur7f20 x1ypdohk x4z9k3i",1:"xbnpv00 xur7f20 x1ypdohk x4z9k3i xvz32qw xmfno27 x1hdarym"})[!!f<<0],to:"/integrations",children:"Integrations"}),e.jsx(Z,{className:({isActive:f})=>({0:"xh2izcj x1e3jit xbnpv00 xur7f20 x1ypdohk x4z9k3i",1:"xbnpv00 xur7f20 x1ypdohk x4z9k3i xvz32qw xmfno27 x1hdarym"})[!!f<<0],to:"/ingest",children:"Ingest"}),e.jsx(Z,{className:({isActive:f})=>({0:"xh2izcj x1e3jit xbnpv00 xur7f20 x1ypdohk x4z9k3i",1:"xbnpv00 xur7f20 x1ypdohk x4z9k3i xvz32qw xmfno27 x1hdarym"})[!!f<<0],to:"/workspaces",children:"Workspaces"})]}),e.jsx(Oe,{})]})})}function It(){const{recordUri:t,setRecordUri:n,autoRunOnSelect:i,setAutoRunOnSelect:m,previewState:h,previewLoading:k,materializeMessage:j,materializeLoading:y,runPreview:S,materializeTasks:R,previewUrl:c,planId:p,warnings:g,copyToClipboard:l}=ae(),u=re(),{recordUri:C}=fe(),_=a.useRef(null);a.useEffect(()=>{if(!C)return;const N=decodeURIComponent(C);N&&N!==t&&n(N),N&&i&&_.current!==N&&(_.current=N,S(N))},[i,t,C,S,n]);const x=a.useCallback((N,q)=>{const P=N.trim();if(!P)return;const I=C?decodeURIComponent(C):"";n(P),P!==I&&u(`/plan-preview/${encodeURIComponent(P)}`),q&&S(P)},[u,C,S,n]);return e.jsxs("section",{className:"x15ji50x",children:[e.jsx("h2",{children:"Plan Preview"}),e.jsxs("div",{className:"xrvj5dj x14sj8ly x1665zp3 x1cy8zhl",children:[e.jsx(Ge,{selectedUri:t,onSelect:N=>{x(N,i)}}),e.jsxs("div",{className:"x78zum5 xdt5ytf xou54vl",children:[e.jsxs("div",{className:"x78zum5 xdt5ytf x17d4w8g",children:[e.jsx("label",{htmlFor:"record-uri",children:"Record URI"}),e.jsx("input",{id:"record-uri",type:"text",value:t,onChange:N=>n(N.target.value),placeholder:"manual://proposal/demo"})]}),e.jsxs("div",{className:"x78zum5 x1a02dak x167g77z",children:[e.jsx("span",{children:"Example URIs:"}),Rt.map(N=>e.jsx("button",{type:"button",onClick:()=>x(N,!1),children:N},N))]}),e.jsxs("div",{className:"x78zum5 x1a02dak x167g77z x6s0dn4",children:[e.jsx("button",{type:"button",onClick:()=>{S();const N=t.trim();if(N){const q=C?decodeURIComponent(C):"";N!==q&&u(`/plan-preview/${encodeURIComponent(N)}`)}},disabled:k,children:k?"Running...":"Run Preview"}),e.jsx("button",{type:"button",className:"xht5q6y xvqfk9l x153ncpu xiq63ov x1ypdohk",onClick:R,disabled:y||!t.trim(),children:y?"Materializing...":"Create Project + Materialize Tasks"}),e.jsxs("label",{className:"x3nfvp2 x17d4w8g x6s0dn4",children:[e.jsx("input",{type:"checkbox",checked:i,onChange:N=>m(N.target.checked)}),"Auto-run on select"]}),c&&e.jsx("span",{className:"xfifm61 x1e3jit",children:c})]}),j&&e.jsxs("div",{className:"x1gqud3g x9hd93c xh2izcj",children:[e.jsx("strong",{children:"Materialize:"})," ",j]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x1v2ro7d",children:[h.error&&e.jsx("div",{className:"x1tp81k5",children:h.error}),h.status!==void 0&&e.jsxs("div",{className:"x78zum5 x1a02dak x1v2ro7d xfifm61 xo8r7s1",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",h.status]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Duration:"})," ",h.durationMs," ms"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Request URL:"})," ",h.url]})]}),p&&e.jsxs("div",{className:"x1gqud3g x9hd93c xh2izcj",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"plan_id:"})," ",p]}),e.jsx("button",{type:"button",onClick:()=>l("plan_id",p),children:"Copy plan_id"})]}),g&&g.length>0&&e.jsxs("div",{className:"x1gqud3g x9hd93c xio89g7 x1cmdin5",children:[e.jsx("strong",{children:"Warnings:"}),e.jsx("ul",{children:g.map(N=>e.jsx("li",{children:N},N))})]}),e.jsx(Be,{data:h.data}),h.data!==void 0&&e.jsxs("div",{className:"x9hd93c xht5q6y xb3r6kr",children:[e.jsxs("div",{className:"x15x03d9 xh2izcj xfifm61 xtvhhri x9pfba7",children:[e.jsx("strong",{children:"Response JSON"}),e.jsx("button",{type:"button",onClick:()=>l("response JSON",h.text||JSON.stringify(h.data,null,2)),children:"Copy JSON"})]}),e.jsx(de,{data:h.data})]}),h.data===void 0&&h.text&&e.jsxs("div",{className:"x9hd93c xht5q6y xb3r6kr",children:[e.jsxs("div",{className:"x15x03d9 xh2izcj xfifm61 xtvhhri x9pfba7",children:[e.jsx("strong",{children:"Response Text"}),e.jsx("button",{type:"button",onClick:()=>l("response text",h.text||""),children:"Copy text"})]}),e.jsx("pre",{children:h.text})]})]})]})]})]})}function Ot(){const{eventsState:t,eventsLoading:n,refreshEvents:i,events:m,expandedRowIndex:h,setExpandedRowIndex:k,testSource:j,setTestSource:y,testType:S,setTestType:R,testExternalId:c,setTestExternalId:p,testPayload:g,setTestPayload:l,testState:u,testLoading:C,runEventsTest:_,idempotencyKey:x,copyToClipboard:N}=ae();return e.jsxs("section",{className:"x15ji50x",children:[e.jsx("h2",{children:"Events Viewer"}),e.jsxs("div",{className:"x78zum5 x1a02dak x167g77z x6s0dn4",children:[e.jsx("button",{type:"button",onClick:i,disabled:n,children:n?"Refreshing...":"Refresh"}),t.url&&e.jsx("span",{className:"xfifm61 x1e3jit",children:t.url})]}),e.jsxs("div",{className:"x78zum5 xdt5ytf x1v2ro7d",children:[t.error&&e.jsx("div",{className:"x1tp81k5",children:t.error}),t.status!==void 0&&e.jsxs("div",{className:"x78zum5 x1a02dak x1v2ro7d xfifm61 xo8r7s1",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",t.status]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Duration:"})," ",t.durationMs," ms"]})]}),e.jsx("div",{className:"x9hd93c xw2csxc",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"source"}),e.jsx("th",{children:"type"}),e.jsx("th",{children:"external_id"}),e.jsx("th",{children:"received_at"}),e.jsx("th",{children:"processed_at"}),e.jsx("th",{children:"process_error"})]})}),e.jsxs("tbody",{children:[m.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"xo8r7s1",children:"No events loaded yet."})}),m.map((q,P)=>{const I=q,W=h===P;return e.jsxs("tr",{className:{0:"",1:"x1gqud3g x9hd93c xh2izcj"}[!!W<<0],onClick:()=>k(W?null:P),children:[e.jsx("td",{children:String(I.source??"")}),e.jsx("td",{children:String(I.type??"")}),e.jsx("td",{children:String(I.external_id??I.externalId??"")}),e.jsx("td",{children:String(I.received_at??I.receivedAt??"")}),e.jsx("td",{children:String(I.processed_at??I.processedAt??"")}),e.jsx("td",{children:String(I.process_error??I.processError??"")})]},P)})]})]})}),h!==null&&m[h]!==void 0&&e.jsxs("div",{className:"x9hd93c xht5q6y xb3r6kr",children:[e.jsx("div",{className:"x15x03d9 xh2izcj xfifm61 xtvhhri x9pfba7",children:e.jsx("strong",{children:"Event Details"})}),e.jsx(de,{data:m[h]})]})]}),e.jsx("div",{className:"xjm9jq1 xcxfhbo x9rwyo8"}),e.jsxs("div",{className:"xw7yly9",children:[e.jsx("h3",{children:"POST /events/test"}),e.jsxs("div",{className:"xrvj5dj x1v2ro7d",children:[e.jsxs("label",{children:["Source",e.jsx("input",{type:"text",value:j,onChange:q=>y(q.target.value)})]}),e.jsxs("label",{children:["Type",e.jsx("input",{type:"text",value:S,onChange:q=>R(q.target.value)})]}),e.jsxs("label",{children:["External ID",e.jsx("input",{type:"text",value:c,onChange:q=>p(q.target.value)})]})]}),e.jsxs("label",{className:"x1osaytk",children:["Payload JSON",e.jsx("textarea",{rows:6,value:g,onChange:q=>l(q.target.value)})]}),e.jsxs("div",{className:"x78zum5 x1a02dak x167g77z x6s0dn4",children:[e.jsx("button",{type:"button",onClick:_,disabled:C,children:C?"Sending...":"Send Test Event"}),u.url&&e.jsx("span",{className:"xfifm61 x1e3jit",children:u.url})]}),u.error&&e.jsx("div",{className:"x1tp81k5",children:u.error}),u.status!==void 0&&e.jsxs("div",{className:"x78zum5 x1a02dak x1v2ro7d xfifm61 xo8r7s1",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",u.status]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Duration:"})," ",u.durationMs," ms"]})]}),x&&e.jsxs("div",{className:"x1gqud3g x9hd93c xh2izcj",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"idempotencyKey:"})," ",x]}),e.jsx("button",{type:"button",onClick:()=>N("idempotencyKey",x),children:"Copy idempotencyKey"})]}),u.data!==void 0&&e.jsxs("div",{className:"x9hd93c xht5q6y xb3r6kr",children:[e.jsx("div",{className:"x15x03d9 xh2izcj xfifm61 xtvhhri x9pfba7",children:e.jsx("strong",{children:"Response"})}),e.jsx(de,{data:u.data})]}),u.data===void 0&&u.text&&e.jsxs("div",{className:"x9hd93c xht5q6y xb3r6kr",children:[e.jsx("div",{className:"x15x03d9 xh2izcj xfifm61 xtvhhri x9pfba7",children:e.jsx("strong",{children:"Response Text"})}),e.jsx("pre",{children:u.text})]})]})]})}function $t(){return e.jsx("section",{className:"x15ji50x",children:e.jsx(Ke,{})})}function Mt(){const{templateKey:t}=fe(),n=re(),i=t?decodeURIComponent(t):void 0;return e.jsxs("section",{className:"x15ji50x",children:[e.jsx("h2",{children:"Templates"}),e.jsx(pt,{selectedTemplateKeyOverride:i,onSelectedTemplateKeyChange:m=>{n(m?`/templates/${encodeURIComponent(m)}`:"/templates")}})]})}function At(){const{selectedProjectId:t,setSelectedProjectId:n,contextLookup:i}=ae(),{projectId:m}=fe(),h=re();a.useEffect(()=>{if(!m)return;const j=decodeURIComponent(m);j&&j!==t&&n(j)},[m,t,n]);const k=a.useCallback(j=>{const y=m?decodeURIComponent(m):"";if(j===y){n(j);return}n(j),h(j?`/projects/${encodeURIComponent(j)}`:"/projects")},[h,m,n]);return e.jsx(nt,{selectedProjectId:t,onSelectProject:k,contextLookup:i})}function Lt(){const{selectedWorkspaceId:t,workspaces:n}=ae();return e.jsx(kt,{workspaceId:t,workspaces:n})}function Ut(){const{selectedWorkspaceId:t,workspaces:n}=ae();return e.jsx(zt,{workspaceId:t,workspaces:n})}function Jt(){const{selectedWorkspaceId:t,setSelectedWorkspaceId:n}=ae();return e.jsx(Tt,{selectedWorkspaceId:t,onSelectWorkspace:n})}export{Dt as A,$t as D,Ot as E,Lt as I,It as P,Mt as T,Jt as W,At as a,Ut as b};
